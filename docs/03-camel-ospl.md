The Camel DDS Component
=======================

The Camel DDS component (named camel-ospl) allows messages to be written
to a DDS Topic via a Camel route; or messages to be received from a DDS
Topic via a Camel route using Vortex OpenSplice RT Networking protocol.

The message exchanged by DDS could be either the IDL-typed DDS sample
(default mode), or any Java serializable object (using the
Camel Messages mode).

Maven configuration
-------------------

If you look at the *pom.xml* file generated by the Vortex Gateway's
archetype for *camel-ospl* , you will see the following declarations,
which are required for your Maven project:

``` {.sourceCode .xml}
<dependencyManagement>                                                  
   <dependencies>                                                         
      <!-- Import Gateway's dependencyManagement. -->                         
      <!-- Thus all dependencies used by Gateway are -->                      
      <!-- referenced with appropriate version numbers. -->                   
      <dependency>                                                      
         <groupId>com.adlinktech.gateway</groupId>                                
         <artifactId>parent-pom</artifactId>                                     
         <type>pom</type>                                                        
         <scope>import</scope>                                                   
         <version>${gateway-version}</version>                           
      </dependency>                                                      
   </dependencies>                                                      
</dependencyManagement>                                                 
```

This is to import all version numbers of dependencies the Gateway might
use. Thus, when your project requires a dependency that Gateway has been
tested with, you don't have to specify its version number again.

``` {.sourceCode .xml}
<dependencies>                                                         
   <!-- Gateway's Camel OpensSpliceDDS endpoint -->                    
   <dependency>                                                        
      <groupId>com.adlinktech.gateway</groupId>                         
      <artifactId>camel-ospl</artifactId>                              
      <version>${gateway-version}</version>                            
   </dependency>                                                       

   <!-- Vortex OpenSplice -->                                              
   <dependency>                                                        
      <groupId>org.opensplice</groupId>                                
      <artifactId>dcpssaj</artifactId>                                 
   </dependency>                                                      
</dependencies>                                                         
```

These are your project's explicit dependencies on Vortex Gateway's
*camel-ospl* component and Vortex OpenSplice's *dcpssaj.jar* file.

Dependencies on Apache Camel's artefacts are implied, since *camel-ospl*
depends on those artefacts.

Note that the scope of Vortex OpenSplice's *dcpssaj* dependency is
'*system*', because this *jar* has to be found in the
*\$OSPL\_HOME/jar/* directory. This is configured in the imported Vortex
Gateway's parent-pom:

``` {.sourceCode .xml}
<build>                                                                 
   <plugins>                                                               
      <!-- OpenSplice IDL compilation plugin -->                              
      <plugin>                                                                
         <groupId>com.adlinktech.gateway</groupId>                               
         <artifactId>opensplice-idl-plugin</artifactId>                         
         <version>${gateway-version}</version>                                  
         <executions>                                                            
            <execution>                                                             
               <phase>generate-sources</phase>                                        
               <goals>                                                                 
                  <goal>idl-compile</goal>                                                
               </goals>                                                                
            </execution>                                                            
         </executions>                                                           
      </plugin>                                                               
   </plugins>                                                              
</build>                                                               
```

The Vortex Gateway's *opensplice-idl-plugin* is used by Maven at the
'*generate-sources*' phase, to process all IDL files placed in the
*src/main/idl* directory and generate Java classes for DDS types,
DataReaders and DataWriters. Those classes will be used at runtime by
your Gateway project.

More configuration options for this plugin are described in
The Camel DDSI Component.

The Vortex Gateway opensplice-idl-plugin for Maven
--------------------------------------------------

The *opensplice-idl-plugin* for Maven drives the Vortex OpenSplice
*idlpp* command to process IDL files and generate corresponding code
(DDS types and typed DDS DataReaders and DataWriters).

By default ( *i.e.* without additional configuration) this plugin
searches for files with an '*.idl*' extension in the *src/main/idl/*
directory, and generates Java code in the
*target/generated-sources/idl/* directory.

The generated Java files are automatically added to the list of Java
source files to be compiled by Maven during the '*compile*' phase.

In addition, the following optional parameters can be configured:

+----------------+-------------+-----------------------------------------+
| **Name**       | **Type**    | **Description**                         |
+================+=============+=========================================+
| outDir         | File        | The directory to output the generated   |
|                |             | sources to.                             |
|                |             |                                         |
|                |             | Default value is:                       |
|                |             | *\${dollar}{project.build.directory}/   |
|                |             | generated-sources/idl*                  |
+----------------+-------------+-----------------------------------------+
| includeDirs    | File\[\]    | Additional include directories          |
|                |             | containing additional \*.idl files      |
|                |             | required for compilation.               |
+----------------+-------------+-----------------------------------------+
| idlDir         | File        | The source directory containing \*.idl  |
|                |             | files.                                  |
|                |             |                                         |
|                |             | Default value is:                       |
|                |             | *\${dollar}{basedir}/src/main/idl*      |
+----------------+-------------+-----------------------------------------+
| macros         | String\[\]  | Preprocessing macros definitions (used  |
|                |             | with *-D* options)                      |
+----------------+-------------+-----------------------------------------+
| idlc           | String      | The compiler executable.                |
|                |             |                                         |
|                |             | Default value is: *idlc*                |
+----------------+-------------+-----------------------------------------+
| language       | String      | The language of generated code. Should  |
|                |             | be one of 'java', 'c', 'c++' or 'cs'.   |
|                |             |                                         |
|                |             | Default value is: '*java*'              |
+----------------+-------------+-----------------------------------------+
| mode           | String      | Standalone or CORBA mode. Should be     |
|                |             | either '-S' or '-C'.                    |
|                |             |                                         |
|                |             | Default value is: '*-S*'                |
+----------------+-------------+-----------------------------------------+

Endpoint configuration
----------------------

An Apache Camel endpoint using Vortex OpenSplice is configured using
following URI format:

> `dds:topicName:domainID/[topicClass][?options]`

Where *topicName* is the DDS topic name to publish or subscribe,
*domainID* is the DDS domain identifier, and *topicClass* is the
generated class for the topic type (optional in the case of Camel
Messages mode; see Camel Messages mode).

*Options* is a list of optional parameters, separated by '*&*'
characters; for example:

> `?option1=value1&option2=value2&...`

The following options are accepted:

+---------------------------------+---------+---------------------------------+---+
| **Name**                        | **Type* | **Description**                 |   |
|                                 | *       |                                 |   |
+=================================+=========+=================================+===+
| readMode                        | Boolean | Only applies to a consumer      |   |
|                                 |         | endpoint *(from("dds:...'))*.   |   |
|                                 |         |                                 |   |
|                                 |         | By default the DDS DataReader   |   |
|                                 |         | of a consumer endpoint uses the |   |
|                                 |         | `take()` operation. Setting     |   |
|                                 |         | this option to true makes it to |   |
|                                 |         | use the `read()` operation      |   |
|                                 |         | instead.                        |   |
|                                 |         |                                 |   |
|                                 |         | The advantage is that in case   |   |
|                                 |         | of a DISPOSE or WRITEDISPOSE    |   |
|                                 |         | message the data will be valid  |   |
|                                 |         | ( *i.e.* the latest-read data). |   |
|                                 |         | The drawback is that the        |   |
|                                 |         | DataReader consumes more memory |   |
|                                 |         | to keep the latest data in a    |   |
|                                 |         | cache.                          |   |
+---------------------------------+---------+---------------------------------+---+
| ignoreLocalPublishers           | Boolean | Only applies to a consumer      |   |
|                                 |         | endpoint *(from("dds:...'))*.   |   |
|                                 |         |                                 |   |
|                                 |         | Indicate if a consumer must     |   |
|                                 |         | ignore the data published by a  |   |
|                                 |         | local producer (i.e. in the     |   |
|                                 |         | same JVM).                      |   |
|                                 |         |                                 |   |
|                                 |         | By default this option is set   |   |
|                                 |         | to true, avoiding loop for      |   |
|                                 |         | bridge patterns using 2 routes  |   |
|                                 |         | in opposite directions. For     |   |
|                                 |         | instance with a DDS/JMS bridge, |   |
|                                 |         | you configure 2 routes:         |   |
|                                 |         |                                 |   |
|                                 |         | -   a route from JMS to DDS     |   |
|                                 |         | -   a route from DDS to JMS     |   |
|                                 |         |                                 |   |
|                                 |         | If this option is set to false, |   |
|                                 |         | the 2nd route will receive the  |   |
|                                 |         | publications from the 1st       |   |
|                                 |         | route, sending back to JMS data |   |
|                                 |         | which are coming from JMS.      |   |
+---------------------------------+---------+---------------------------------+---+
| partition                       | String  | Corresponds to DDS              |   |
|                                 |         | `PartitionQosPolicy.name`.      |   |
|                                 |         |                                 |   |
|                                 |         | A list of DDS partitions,       |   |
|                                 |         | separated by `,` characters.    |   |
+---------------------------------+---------+---------------------------------+---+
| contentFilter                   | String  | Corresponds to a DDS filter     |   |
|                                 |         | expression to be used on topic  |   |
|                                 |         | (actually a                     |   |
|                                 |         | ContentFilteredTopic is created |   |
|                                 |         | by the endpoint). This is a     |   |
|                                 |         | SQL-like expression as defined  |   |
|                                 |         | in the DDS specification.       |   |
|                                 |         |                                 |   |
|                                 |         | *WARNING* : the expression must |   |
|                                 |         | use percent-encoding for URI    |   |
|                                 |         | reserved and unsafe characters  |   |
|                                 |         | (*e.g.* `=` = `%3D` , `>` =     |   |
|                                 |         | `%3E` , ..)                     |   |
+---------------------------------+---------+---------------------------------+---+
| deadlinePeriod                  | Double  | Corresponds to DDS              |   |
|                                 |         | `DeadlineQosPolicy.period`.     |   |
|                                 |         |                                 |   |
|                                 |         | A float representing a time in  |   |
|                                 |         | seconds.                        |   |
+---------------------------------+---------+---------------------------------+---+
| destinationOrder                | String  | Corresponds to DDS              |   |
|                                 |         |                                 |   |
|                                 |         | `DestinationOrderQosPolicy.kind |   |
|                                 |         | `.                              |   |
|                                 |         |                                 |   |
|                                 |         | Possible values:                |   |
|                                 |         |                                 |   |
|                                 |         | -   *BY\_RECEPTION\_TIMESTAMP*  |   |
|                                 |         | -   *BY\_SOURCE\_TIMESTAMP*     |   |
+---------------------------------+---------+---------------------------------+---+
| durabilityKind                  | String  | Corresponds to DDS              |   |
|                                 |         | `DurabilityQosPolicy.kind`.     |   |
|                                 |         |                                 |   |
|                                 |         | Possible values:                |   |
|                                 |         |                                 |   |
|                                 |         | -   *VOLATILE*                  |   |
|                                 |         | -   *TRANSIENT*                 |   |
|                                 |         | -   *TRANSIENT\_LOCAL*          |   |
|                                 |         | -   *PERSISTENT*                |   |
+---------------------------------+---------+---------------------------------+---+
| durabilityServiceCleanupDelay   | Double  | Corresponds to DDS              |   |
|                                 |         | `DurabilityServiceQosPolicy.ser |   |
|                                 |         | vice_cleanup_delay`             |   |
|                                 |         |                                 |   |
|                                 |         | A float representing a time in  |   |
|                                 |         | seconds.                        |   |
+---------------------------------+---------+---------------------------------+---+
| durabilityServiceDepth          | Int     | Corresponds to DDS              |   |
|                                 |         |                                 |   |
|                                 |         | `DurabilityServiceQosPolicy.his |   |
|                                 |         | tory_depth`                     |   |
|                                 |         |                                 |   |
|                                 |         | An integer representing the     |   |
|                                 |         | history depth.                  |   |
+---------------------------------+---------+---------------------------------+---+
| durabilityServiceKind           | String  | Corresponds to DDS              |   |
|                                 |         |                                 |   |
|                                 |         | `DurabilityServiceQosPolicy.his |   |
|                                 |         | tory_kind`                      |   |
|                                 |         |                                 |   |
|                                 |         | Possible values:                |   |
|                                 |         |                                 |   |
|                                 |         | -   *KEEP\_ALL*                 |   |
|                                 |         | -   *KEEP\_LAST*                |   |
+---------------------------------+---------+---------------------------------+---+
| durabilityServiceMaxInstances   | Int     | Corresponds to DDS              |   |
|                                 |         |                                 |   |
|                                 |         | `DurabilityServiceQosPolicy.max |   |
|                                 |         | _instances`                     |   |
|                                 |         |                                 |   |
|                                 |         | An integer representing the     |   |
|                                 |         | maximum number of instances.    |   |
+---------------------------------+---------+---------------------------------+---+
| durabilityServiceMaxSamples     | Int     | Corresponds to DDS              |   |
|                                 |         |                                 |   |
|                                 |         | `DurabilityServiceQosPolicy.max |   |
|                                 |         | _samples`                       |   |
|                                 |         |                                 |   |
|                                 |         | An integer representing the     |   |
|                                 |         | maximum number of samples.      |   |
+---------------------------------+---------+---------------------------------+---+
| durabilityServiceMaxSamplesPerI | Int     | Corresponds to DDS              |   |
| nstance                         |         |                                 |   |
|                                 |         | `DurabilityServiceQosPolicy.max |   |
|                                 |         | _samples_per_instance`          |   |
|                                 |         |                                 |   |
|                                 |         | An integer representing the     |   |
|                                 |         | history depth.                  |   |
+---------------------------------+---------+---------------------------------+---+
| historyDepth                    | String  | Corresponds to DDS              |   |
|                                 |         | `HistoryQosPolicy.depth`.       |   |
|                                 |         |                                 |   |
|                                 |         | An integer representing the     |   |
|                                 |         | maximum number of samples per   |   |
|                                 |         | instance.                       |   |
+---------------------------------+---------+---------------------------------+---+
| historyKind                     | String  | Corresponds to DDS              |   |
|                                 |         | `HistoryQosPolicy.kind`.        |   |
|                                 |         |                                 |   |
|                                 |         | Possible values:                |   |
|                                 |         |                                 |   |
|                                 |         | -   *KEEP\_ALL*                 |   |
|                                 |         | -   *KEEP\_LAST*                |   |
+---------------------------------+---------+---------------------------------+---+
| latencyDuration                 | Double  | Corresponds to DDS              |   |
|                                 |         |                                 |   |
|                                 |         | `LatencyBudgetQosPolicy.duratio |   |
|                                 |         | n`.                             |   |
|                                 |         |                                 |   |
|                                 |         | A float representing a time in  |   |
|                                 |         | seconds.                        |   |
+---------------------------------+---------+---------------------------------+---+
| lifespanDuration                | Double  | Corresponds to DDS              |   |
|                                 |         | `LifespanQosPolicy.duration`.   |   |
|                                 |         |                                 |   |
|                                 |         | A float representing a time in  |   |
|                                 |         | seconds.                        |   |
+---------------------------------+---------+---------------------------------+---+
| livelinessDuration              | Double  | Corresponds to DDS              |   |
|                                 |         |                                 |   |
|                                 |         | `LivelinessQosPolicy.lease_dura |   |
|                                 |         | tion`.                          |   |
|                                 |         |                                 |   |
|                                 |         | A float representing a time in  |   |
|                                 |         | seconds.                        |   |
+---------------------------------+---------+---------------------------------+---+
| livelinessKind                  | String  | Corresponds to DDS              |   |
|                                 |         | `LivelinessQosPolicy.kind`.     |   |
|                                 |         |                                 |   |
|                                 |         | Possible values:                |   |
|                                 |         |                                 |   |
|                                 |         | -   *AUTOMATIC*                 |   |
|                                 |         | -   *MANUAL\_BY\_PARTICIPANT*   |   |
|                                 |         | -   *MANUAL\_BY\_TOPIC*         |   |
+---------------------------------+---------+---------------------------------+---+
| ownershipKind                   | String  | Corresponds to DDS              |   |
|                                 |         | `OwnershipQosPolicy.kind`.      |   |
|                                 |         |                                 |   |
|                                 |         | Possible values:                |   |
|                                 |         |                                 |   |
|                                 |         | -   *SHARED*                    |   |
|                                 |         | -   *EXCLUSIVE*                 |   |
+---------------------------------+---------+---------------------------------+---+
| ownershipStrength               | String  | Corresponds to DDS              |   |
|                                 |         |                                 |   |
|                                 |         | `OwnershipStrengthQosPolicy.val |   |
|                                 |         | ue`.                            |   |
|                                 |         |                                 |   |
|                                 |         | An integer representing the     |   |
|                                 |         | ownership strength.             |   |
+---------------------------------+---------+---------------------------------+---+
| presentationAccessScope         | String  | Corresponds to DDS              |   |
|                                 |         |                                 |   |
|                                 |         | `PresentationQosPolicy.access_s |   |
|                                 |         | cope`.                          |   |
|                                 |         |                                 |   |
|                                 |         | Possible values:                |   |
|                                 |         |                                 |   |
|                                 |         | -   *INSTANCE*                  |   |
|                                 |         | -   *TOPIC*                     |   |
|                                 |         | -   *GROUP*                     |   |
+---------------------------------+---------+---------------------------------+---+
| presentationCoherentAccess      | Boolean | Corresponds to DDS              |   |
|                                 |         |                                 |   |
|                                 |         | `PresentationQosPolicy.coherent |   |
|                                 |         | _access`                        |   |
+---------------------------------+---------+---------------------------------+---+
| presentationOrderedAccess       | Boolean | Corresponds to DDS              |   |
|                                 |         |                                 |   |
|                                 |         | `PresentationQosPolicy.ordered_ |   |
|                                 |         | access`                         |   |
+---------------------------------+---------+---------------------------------+---+
| readerDataLifecycleAutopurgeDis | Double  | Corresponds to DDS              |   |
| posedDelay                      |         | `ReaderDataLifecycleQosPolicy.a |   |
|                                 |         | utopurge_disposed_samples_delay |   |
|                                 |         | `                               |   |
|                                 |         |                                 |   |
|                                 |         | A float representing a time in  |   |
|                                 |         | seconds.                        |   |
+---------------------------------+---------+---------------------------------+---+
| readerDataLifecycleAutopurgeNow | Double  | Corresponds to DDS              |   |
| riterDelay                      |         |                                 |   |
|                                 |         | `ReaderDataLifecycleQosPolicy.a |   |
|                                 |         | utopurge_nowriter_samples_delay |   |
|                                 |         | `                               |   |
|                                 |         |                                 |   |
|                                 |         | A float representing a time in  |   |
|                                 |         | seconds.                        |   |
+---------------------------------+---------+---------------------------------+---+
| reliabilityBlockingTime         | Double  | Corresponds to DDS              |   |
|                                 |         |                                 |   |
|                                 |         | `ReliabilityQosPolicy.max_block |   |
|                                 |         | ing_time`                       |   |
|                                 |         |                                 |   |
|                                 |         | A float representing a time in  |   |
|                                 |         | seconds.                        |   |
+---------------------------------+---------+---------------------------------+---+
| reliabilityKind                 | String  | Corresponds to DDS              |   |
|                                 |         | `ReliabilityQosPolicy.kind`.    |   |
|                                 |         |                                 |   |
|                                 |         | Possible values:                |   |
|                                 |         |                                 |   |
|                                 |         | -   *RELIABLE*                  |   |
|                                 |         | -   *BEST\_EFFORT*              |   |
+---------------------------------+---------+---------------------------------+---+
| resourceLimitsMaxInstances      | Int     | Corresponds to DDS              |   |
|                                 |         |                                 |   |
|                                 |         | `ResourceLimitsQosPolicy.max_in |   |
|                                 |         | stances`                        |   |
|                                 |         |                                 |   |
|                                 |         | An integer representing the     |   |
|                                 |         | maximum number of instances.    |   |
+---------------------------------+---------+---------------------------------+---+
| resourceLimitsMaxSamples        | Int     | Corresponds to DDS              |   |
|                                 |         | `ResourceLimitsQosPolicy.max_sa |   |
|                                 |         | mples`.                         |   |
|                                 |         |                                 |   |
|                                 |         | An integer representing the     |   |
|                                 |         | maximum number of samples.      |   |
+---------------------------------+---------+---------------------------------+---+
| resourceLimitsMaxSamplesPerInst | Int     | Corresponds to DDS              |   |
| ance                            |         |                                 |   |
|                                 |         | `ResourceLimitsQosPolicy.max_sa |   |
|                                 |         | mples_per_instance`             |   |
|                                 |         |                                 |   |
|                                 |         | An integer representing the     |   |
|                                 |         | maximum number of samples per   |   |
|                                 |         | instance.                       |   |
+---------------------------------+---------+---------------------------------+---+
| timebasedFilter                 | Double  | Corresponds to DDS              |   |
|                                 |         |                                 |   |
|                                 |         | `TimeBasedFilterQosPolicy.minim |   |
|                                 |         | um_separation`                  |   |
|                                 |         |                                 |   |
|                                 |         | A float representing a time in  |   |
|                                 |         | seconds.                        |   |
+---------------------------------+---------+---------------------------------+---+
| transportPriority               | Int     | Corresponds to DDS              |   |
|                                 |         | `TransportPriorityQosPolicy.val |   |
|                                 |         | ue`.                            |   |
|                                 |         |                                 |   |
|                                 |         | An integer representing the     |   |
|                                 |         | transport priority.             |   |
+---------------------------------+---------+---------------------------------+---+
| writerDataLifecycleAutodispose  | Boolean | Corresponds to DDS              |   |
|                                 |         |                                 |   |
|                                 |         | `WriterDataLifecycleQosPolicy.a |   |
|                                 |         | utodispose_unregistered_instanc |   |
|                                 |         | es`                             |   |
+---------------------------------+---------+---------------------------------+---+

Content of Camel Exchanges
--------------------------

Each Camel Exchange produced by the DDS endpoint contains the data as
body of the IN message. The data has for its type the Java class
representing the Topic Type.

Note that this data might be 'invalid' ( *i.e.* with some members not
set, or with dummy values), if the instance state changes. See the
Vortex OpenSplice reference guide for more details
(ReaderDataLifecycleQos chapter). This can be checked with the
*SampleInfo.valid\_data* boolean (see below).

The IN message contains the following information as headers:

  -------------------------------------------------------------------------
  **Name**      **Type**                                **Description**
  ------------- --------------------------------------- -------------------
  DDS\_SAMPLE\_ DDS.SampleInfo                          The *SampleInfo*
  INFO                                                  object read by the
                                                        DDS Reader with the
                                                        data.

  DDS\_DISPOSE  com.adlinktech.gateway.camelospl.DdsDis This header is
                poseHeader                              present only if the
                                                        instance was
                                                        disposed. In such a
                                                        case it's set
                                                        either to *DISPOSE*
                                                        if the body of the
                                                        message contains
                                                        invalid data, or to
                                                        *WRITEDISPOSE* if
                                                        the body of the
                                                        message contains
                                                        the last valid data
                                                        sent by the
                                                        publisher before
                                                        the disposal.
  -------------------------------------------------------------------------

Example of route
----------------

Below is an example of a simple Camel route definition from a DDS
endpoint to a Processor displaying the data:

``` {.sourceCode .java}
final String fromURI =                                                
   "dds:ChatMessage:0/Chat.ChatMessage?ReliabilityKind=RELIABLE&Partition=ChatRoom";                                                     
final CamelContext ctx = new DefaultCamelContext();                     
ctx.addRoutes(new RouteBuilder() {                                      
  public void configure() {                                               
    // from DDS endpoint to a Processor displaying the received message.    
    from(fromURI).process(new Processor() {                                              
       public void process(Exchange e) {                                       
          Chat.ChatMessage msg = (Chat.ChatMessage) e.getIn().getBody();           
          String content = msg.content;                                           
          System.out.println(content);                                           
       }
    });                                                                     
  }                                                                       
});

ctx.start();                                                            
```

In this example the DDS endpoint subscribes to the '*ChatMessage*' topic
in DDS Domain '*0*' using DDS partition '*ChatRoom*'. The topic
Reliability QoS is set to '*RELIABLE*'.

Dynamic DDS QoS changes
-----------------------

The camel-ospl component offers the possibility to change at runtime
some of the DDS QoS which are used by the Vortex OpenSplice entities
(Publisher, Subscriber, DataWriter or DataReader).

### Publisher / DataWriter changeable QoS

The Publisher and DataWriter DDS entities are managed by a
*com.adlinktech.gateway.camelospl.DdsProducer* class which implements
the *org.apache.camel.Producer* interface.

The following operations can be used at runtime to change some of the
DDS QoS used for subsequent Camel exchanges:

-   `public void changeDeadlinePeriod(double period) throws DdsException;`
-   `public void changeLatencyDuration(double duration) throws DdsException;`
-   `public void changeOwnershipStrength(int strength) throws DdsException;`
-   `public void changeTransportPriority(int priority) throws DdsException;`
-   `public void changeLifespanDuration(double duration) throws DdsException;`
-   `public void changePartition(String partitionStr) throws DdsException;`

Example of usage:

``` {.sourceCode .java}
final String toURI =                                                    
   "dds:ChatMessage:0/Chat.ChatMessage?Partition=ChatRoom-1";              
final CamelContext ctx = new DefaultCamelContext();                     
final DdsProducer toProducer =                                          
(DdsProducer) ctx.getEndpoint(toURI).createProducer();                  
ctx.addRoutes(new RouteBuilder() {                                      
   public void configure() {                                               
      from("...") // from any endpoint                                        
      .process(toProducer); // equivalent to: .to(toUri);                     
   }                                                                       
});                                                                     

// ... later, change the partition used by the DdsProducer's entities   
toProducer.changePartition("ChatRoom-2");                               
```

### Subscriber / DataReader changeable QoS

The Subscriber and DataReader DDS entities are managed by the class
*com.adlinktech.gateway.camelospl.DdsConsumer* which implements the
*org.apache.camel.Consumer* interface.

The following operations can be used at runtime to change some of the
DDS QoS used for subsequent Camel exchanges:

-   `public void changeDeadlinePeriod(double period) throws DdsException;`
-   `public void changeLatencyDuration(double duration) throws DdsException;`
-   `public void changeTimebasedFilter(double timebasedFilter) throws DdsException;`
-   `public void changePartition(String partitionStr) throws DdsException;`

Example of usage:

``` {.sourceCode .java}
final String toURI =                                                    
   "dds:ChatMessage:0/Chat.ChatMessage?Partition=ChatRoom-1";              
final CamelContext ctx = new DefaultCamelContext();                     
ctx.addRoutes(new RouteBuilder() {                                      
   public void configure() {                                               
      from(fromURI)                                                           
      .routeId("ChatRoute") //give an ID to the Route for later retrieval    
      .process(new Processor() {                                              
         public void process(Exchange e) {                                       
            Chat.ChatMessage msg = (Chat.ChatMessage)e.getIn().getBody();           
            String content = msg.content;                                           
            System.out.println(content);                                            
         }                                                                       
      });                                                                     
   }                                                                       
});                                                                     

// ... later, change the partition for the DdsConsumer's entities       
DdsConsumer ddsConsumer =                                               
   (DdsConsumer) ctx.getRoute("ChatRoute").getConsumer();                  
ddsConsumer.changePartition("ChatRoom-2");                              
```

### Per-message changes

It is also possible to change some of the Producer QoS on-the-fly for a
single message. To do this, add the following headers to the Camel
message sent to a DDS Producer:

  --------------------------------------------------------------------
  **Header name**              **Header value**
  ---------------------------- ---------------------------------------
  `dds.ownershipStrength`      An integer representing the
                               *ownershipStrength* value to be used
                               for this message.

  `dds.transportPriority`      An integer representing the
                               *transportPriority* value to be used
                               for this message.

  `dds.lifespanDuration`       A float representing the
                               *lifespanDuration* value (in seconds)
                               to be used for this message.
  --------------------------------------------------------------------

Example of usage:

``` {.sourceCode .java}
// A route publishing Alarms to DDS and changing the                    
// transportPriority QoS depending the alarm level                      
from("...")                                                             
.choice()                                                               
   .when().groovy("request.body.alarmLevel == 'LOW'")                      
      .setHeader("dds.transportPriority", constant(1))                        
   .when().groovy("request.body.alarmLevel == 'HIGH'")                     
      .setHeader("dds.transportPriority", constant(3))                        
.endChoice()                                                            
.to("dds:Alarms:0/com.adlinktech.demo.AlarmType");                       
```

Camel Messages mode
-------------------

This mode allows Camel Messages to be exchanged *via* DDS. This includes
the Message's headers, attachments and body, providing they contain only
Serializable Java objects.

This mode is activated when you don't specify a *topicClass* in the
endpoint URI.

Below is an example of Camel Messages mode usage, with a Java String as
the message body:

``` {.sourceCode .java}
final String fromURI = "dds:ExampleStrTopic:0/?target=stringTarget";    
final CamelContext ctx = new DefaultCamelContext();                     
Endpoint endpoint = ctx.getEndpoint(fromURI);                           
// Define the route from DDS endpoint to a Processor                    
// displaying the received data.                                        
ctx.addRoutes(new RouteBuilder() {                                      
   public void configure() {                                               
      from(fromURI)                                                           
      .process(new Processor() {                                              
         public void process(Exchange e) {                                       
            System.out.println((String)e.getIn().getBody());                        
         }                                                                       
      });                                                                     
   }                                                                       
});                                                                     

// create a ProducerTemplate                                            
ProducerTemplate template = ctx.createProducerTemplate();               

// use ProducerTemplate to send Exchange to DDS endpoint                
template.send(endpoint, new Processor() {                               
   public void process(Exchange exchange) {                                
      exchange.getIn().setBody("Hello World!");                               
   }                                                                       
});                                                                     
```

The '*target*' option used in the URI is specific to the Camel Messages
mode. This extra value is sent through DDS with the Camel message and
allows consuming routes to filter messages according to this '*target*'
value.

DDS Polling Consumer
--------------------

The Vortex OpenSplice endpoint provides a DDSPollingConsumer
implementation allowing it to wait for incoming DDS data. Hence the
caller can poll for messages when it is ready.

The DDSPollingConsumer implements the three polling methods of the Camel
PollingConsumer interface in addition to three other polling methods
that allow the caller to specify some DDS specific options in order to
select the set of data to be read.

  ------------------------------------------------------------------------
  **Method Name**                             **Description**
  ------------------------------------------- ----------------------------
  `receive()`                                 Waits until a message is
                                              available

  `receive(Map<String, Object> options)`      blocking forever.

  `receive(long timeout)`                     Waits up to the given
                                              timeout and

  `receive(Map<String, Object> options, long  within the given timeout.
  timeout)`                                   

  `receiveNoWait()`                           Reads a message immediately
                                              without

  `receiveNoWait(Map<String, Object> options) is received.
  `                                           
  ------------------------------------------------------------------------

The '*options*' parameter can express the states of the DDS messages to
be read as well as a condition that allows it to read the messages with
content-based filtering. The options map keys correspond to the headers
names described in the table in DynamicPollEnricher\_.

Note that the DDSPollingConsumer performs a DDS `read()` operation and
not a `take()` operation. It means that the data is kept in the DDS
middleware and can be read again if necessary.

Below is an example of how to use the DDS PollingConsumer.

``` {.sourceCode .java}
// Getting the DDS topicA endpoint                                       
Endpoint ddsEndpointA = camelContext.getEndpoint("dds:topicA:0/TypeA");  

// Create PollingConsumer to poll data from topicA                       
DynamicPollingConsumer pollConsumer =                                    
   (DynamicPollingConsumer) ddsEndpointA.createPollingConsumer();          

// Setting the polling options : only not read and alive samples          

Map<String, Object> conditions = new HashMap<String, Object>();
conditions.put("DDS_SAMPLE_STATE", NOT_READ_SAMPLE_STATE.value);   
conditions.put("DDS_INSTANCE_STATE", ALIVE_INSTANCE_STATE.value);   

long wait_timeout = 3000; // milliseconds                               

// Polling for topicA messages with the given options                    
Exchange e = pollConsumer.receive(conditions, wait_timeout);            
if (e != null) {                                                         
   // to process the message                                               
} else {                                                                
   // TIMEOUT                                                              
}                                                                       
```

Additional Apache Camel Processors
----------------------------------

### DynamicPollEnricher

Apache Camel already provides a *pollEnrich* pattern (see
[](http://camel.apache.org/content-enricher.html) ) allowing in a Camel
route to enrich an incoming message with data from a PollingConsumer.

For Camel versions 2.15 and older, the *pollEnrich* pattern is not able
to extract data from current exchange to influence the polling ( *e.g.*
to poll data with the same key as in the received message). See the note
in [](http://camel.apache.org/content-enricher.html).

From Camel 2.16 onwards both enrich and *pollEnrich* supports dynamic
endpoints that uses an Expression to compute the uri, which allows to
use data from the current Exchange. See more details at Message Endpoint
[](http://camel.apache.org/message-endpoint.html). However, the usage of
dynamic endpoints is not appropriate in our case, because it would force
the creation of a DataWriter for each polling query.

The Camel DDS component have therefore introduced a new class
*com.adlinktech.gateway.camelext.DynamicPollEnricher* which can be use
as a Camel Processor. This Processor implements a missing feature in
*pollEnricher*, passing incoming messages' headers to a specific
implementation of *PollingConsumer* for DDS endpoint creating a
*DDSQueryCondition* according to the headers' options and calling
*DataReader.read\_w\_condition()* .

Note that the *DynamicPollEnricher* uses a non blocking operation of the
*PollingConsumer* to receive the messages. If no message is available
yet, it returns immediately with a null exchange.

By default the *DynamicPollEnricher* class uses the reply from
*PollingConsumer* as outgoing message. But another *AggregationStrategy*
can be set to merge the reply with original incoming message. Use the
operation *PollingConsumer.setAggregationStrategy()* to set another
strategy.

The accepted header options are:

+----------------------+------------+-------------------------------------------+
| **Name**             | **Type**   | **Description**                           |
+======================+============+===========================================+
| DDS\_SAMPLE\_STATE   | int        | A mask of matching SampleStates.          |
|                      |            |                                           |
|                      |            | Default value is                          |
|                      |            | *DDS.ANY\_SAMPLE\_STATE.value*            |
+----------------------+------------+-------------------------------------------+
| DDS\_VIEW\_STATE     | int        | A mask of matching ViewStates.            |
|                      |            |                                           |
|                      |            | Default value is                          |
|                      |            | *DDS.ANY\_VIEW\_STATE.value*              |
+----------------------+------------+-------------------------------------------+
| DDS\_INSTANCE\_STATE | int        | A mask of matching InstanceStates.        |
|                      |            |                                           |
|                      |            | Default value is                          |
|                      |            | *DDS.ANY\_INSTANCE\_STATE\_value*         |
+----------------------+------------+-------------------------------------------+
| DDS\_QUERY\_EXPRESSI | String     | A query expression.                       |
| ON                   |            |                                           |
|                      |            | Default value is *null* (meaning a        |
|                      |            | *ReadCondition* is used instead of a      |
|                      |            | *QueryCondition* ).                       |
+----------------------+------------+-------------------------------------------+
| DDS\_QUERY\_PARAMETE | String\[\] | An array of query parameters.             |
| RS                   |            |                                           |
|                      |            | Default value is an empty array.          |
+----------------------+------------+-------------------------------------------+

Below is an example of the *DynamicPollEnricher* class:

``` {.sourceCode .java}
// Some DDS endpoints. Messages come from topicA and have to be enriched 
// by matching data from topicB.
Endpoint ddsEndpointA = camelContext.getEndpoint("dds:topicA:0/TypeA");  
Endpoint ddsEndpointB = camelContext.getEndpoint("dds:topicB:0/TypeB");  

// Create a DynamicPollEnricher polling from topicB
DynamicPollEnricher pollEnricher = new                                   
   DynamicPollEnricher("dds:topicB:0/TypeB");                                       

// Set custom strategy, creating a TypeC from a TypeA + TypeB            
pollEnricher.setAggregationStrategy(new AggregationStrategy() {          
   @Override                                                               
   public Exchange aggregate(Exchange oldExchange, Exchange newExchange)
   { 
      // get TypeA and TypeB                                                  
      TypeA a = (TypeA) oldExchange.getIn().getBody();                        
      TypeB b = (TypeB) newExchange.getIn().getBody();                        
      // create TypeC                                                         
      TypeC c = new TypeC(a,b);                                               
      // replace oldExchange's body with TypeC and return it                  
      oldExchange.getIn().setBody(c);                                         
      return oldExchange;                                                     
   }                                                                       
});                                                                      

// Route from TopicA topic to the PollEnricher getting a TopicB sample   
// with TopicA.index = TopicB.index and aggregating both as a NamedMessage.           
from(ddsEndpointA)                                                       
// Query expression to get TopicB with index = first param              
.setHeader("DDS\_QUERY\_EXPRESSION", constant("index=%0"))              
// Query param: use Groovy to get TopicA.index and create String array  
.setHeader("DDS\_QUERY\_PARAMETERS")
.groovy("[request.body.index.toString()]")                                                                   
// send message with headers to pollEnricher                            
.process(pollEnricher)                                                  
// now display resulting message (TypeC is expected)                    
.process(new Processor() {                                              
   public void process(Exchange e) {                                       
      System.out.println((TypeC)e.getIn().getBody());                         
   }                                                                       
});                                                                     
```

For another example of *DynamicPollEnricher* usage, look at Vortex
Gateway's *examples/shape-java* code. It contains an example of a route
from a *Circle* topic, polling correlated data from a *Square* topic of
the same color and computes the average position between *Circle* and
*Square* and publishes a *Triangle* topic in that position.
